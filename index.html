<!DOCTYPE html>
<html lang="ko-KR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1 class="title">LiveCHAT</h1>
        <p class="reset">초기화</p>
    </header>
    <main>
        <div class="container">
            <div class="chat_view">
            </div>
            <div>
                <form class="chating"><textarea name="chat" cols="30" rows="10"></textarea>
                    <button type="submit">입력</button>
                </form>
            </div>
        </div>
    </main>
    <footer>
        copyright 2023. All right reserved
    </footer>
</body>
<script>
    const $chat_view = document.querySelector('.chat_view');
    const $textarea = document.querySelector('textarea');
    const $button = document.querySelector('button');
    const $reset = document.querySelector('.reset');
    const url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;
    const data = [];
    let key = 0;

    $reset.addEventListener('click', function reset() {
        window.localStorage.clear();
        $chat_view.innerHTML = '';
        key = 0;
    });

    function printuser($key) {
        const local = window.localStorage;
        const $user = document.createElement('div');
        $user.className = 'user';
        $user.innerHTML = local.getItem('user' + $key);
        if (local.getItem('chatgpt') != '') {
            $chat_view.appendChild($user);
        }
    }

    function printgpt($key) {
        const local = window.localStorage;
        const $chatgpt = document.createElement('div');
        $chatgpt.className = 'chatgpt';
        $chatgpt.innerHTML = local.getItem('chatgpt' + $key);
        if (local.getItem('chatgpt') != '') {
            $chat_view.appendChild($chatgpt);
        }
    }

    function printAll(params) {
        let i = 0;
        while (i <= 100) {
            if (window.localStorage.getItem('user' + i) == null) {
                break;
            } else {
                console.log(i);
                console.log(window.localStorage.getItem('user' + i));
            }
            printuser(i);
            i++;
            printgpt(i);
        }
    }
    printAll();

    data.push({
        "role": "system",
        "content": "assistant는 운동 루틴을 추천해주는 트레이너입니다."
    })

    $button.addEventListener('click', e => {
        e.preventDefault()
        const contents = $textarea.value
        data.push({
            "role": "user",
            "content": contents
        })
        window.localStorage.setItem('user' + key, $textarea.value);
        $textarea.value = '';
        printuser(key);
        chatGPTAPI();
        key++;
    })

    function chatGPTAPI() {
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            redirect: 'follow'
        })
            .then(res => res.json())
            .then(res => {
                console.log(res)
                let answer = res.choices[0].message.content + '';
                answer.replace('\n', '<br>');
                answer.replace('1.', '<br>1.');
                window.localStorage.setItem('chatgpt' + key, answer);
                printgpt(key);
            })
    }
</script>

</html>