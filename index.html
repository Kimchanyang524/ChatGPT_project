<!DOCTYPE html>
<html lang="ko-KR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1 class="title">LiveCHAT</h1>
        <p class="reset">초기화</p>
    </header>
    <main>
        <div class="container">
            <div class="chat_view">
            </div>
            <div>
                <form class="chating"><textarea name="chat" cols="30" rows="10"></textarea>
                    <button type="submit">입력</button>
                </form>
            </div>
        </div>
    </main>
    <footer>
        copyright 2023. All right reserved
    </footer>
</body>
<script>
    const $chat_view = document.querySelector('.chat_view');
    const $textarea = document.querySelector('textarea');
    const $button = document.querySelector('button');
    const $reset = document.querySelector('.reset');
    const url = `https://estsoft-openai-api.jejucodingcamp.workers.dev/`;
    const data = [];

    $reset.addEventListener('click', function reset() {
        window.localStorage.clear();
        printChat();
    });

    function printuser() {
        const local = window.localStorage;
        const $user = document.createElement('div');
        $user.className = 'user';
        $user.innerHTML = local.getItem('user');
        if (local.getItem('chatgpt') != '') {
            $chat_view.appendChild($user);
        }
    }
    printuser();

    function printgpt() {
        const local = window.localStorage;
        const $chatgpt = document.createElement('div');
        $chatgpt.className = 'chatgpt';
        $chatgpt.innerHTML = local.getItem('chatgpt');
        if (local.getItem('chatgpt') != '') {
            $chat_view.appendChild($chatgpt);
        }
    }
    printgpt();

    data.push({
        "role": "system",
        "content": "assistant는 운동 루틴을 추천해주는 트레이너입니다."
    })

    $button.addEventListener('click', e => {
        e.preventDefault()
        const contents = $textarea.value
        data.push({
            "role": "user",
            "content": contents
        })
        window.localStorage.setItem('user', $textarea.value);
        $textarea.value = ''
        printuser();
        chatGPTAPI();
    })

    function chatGPTAPI() {
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
            redirect: 'follow'
        })
            .then(res => res.json())
            .then(res => {
                console.log(res)
                // 답변 온 것을 assistant로 저장
                // $chatgpt.innerHTML = `<p>${res.choices[0].message.content}</p>`
                window.localStorage.setItem('chatgpt', res.choices[0].message.content);
                printgpt();
            })
    }
</script>

</html>